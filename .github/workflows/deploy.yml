name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-west1
  REPOSITORY: esl-game-lab
  API_SERVICE: esl-game-lab-api
  FRONTEND_SERVICE: esl-game-lab

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    outputs:
      api_url: ${{ steps.deploy-api.outputs.api_url }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker $REGION-docker.pkg.dev

      - name: Create Artifact Registry Repository
        run: |
          gcloud artifacts repositories create $REPOSITORY \
            --repository-format=docker \
            --location=$REGION \
            --description="ESL Game Lab Docker images" \
            || echo "Repository already exists, continuing."

      - name: Build and Push API Docker Image
        run: |
          API_IMAGE=$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$API_SERVICE:${{ github.sha }}
          docker build \
            -t $API_IMAGE \
            -f "./esl-game-lab (1)/api/Dockerfile" \
            "./esl-game-lab (1)/api"
          docker push $API_IMAGE

      - name: Deploy API to Cloud Run
        id: deploy-api
        run: |
          API_IMAGE=$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$API_SERVICE:${{ github.sha }}

          gcloud run deploy $API_SERVICE \
            --image $API_IMAGE \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --port 8080 \
            --set-env-vars "NODE_ENV=production,GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
            --clear-volume-mounts \
            --remove-labels managed-by

          API_URL=$(gcloud run services describe $API_SERVICE \
            --region $REGION \
            --format 'value(status.url)')
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API deployed to: $API_URL"

      - name: Verify API health
        run: |
          sleep 10
          curl -f "${{ steps.deploy-api.outputs.api_url }}/health" \
            || (echo "API health check failed" && exit 1)

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-api

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker $REGION-docker.pkg.dev

      - name: Build and Push Frontend Docker Image
        run: |
          FRONTEND_IMAGE=$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$FRONTEND_SERVICE:${{ github.sha }}
          docker build \
            --build-arg VITE_API_URL="${{ needs.deploy-api.outputs.api_url }}" \
            --build-arg VITE_ADMIN_CODE="${{ secrets.VITE_ADMIN_CODE }}" \
            -t $FRONTEND_IMAGE \
            "./esl-game-lab (1)"
          docker push $FRONTEND_IMAGE

      - name: Deploy Frontend to Cloud Run
        id: deploy-frontend
        run: |
          FRONTEND_IMAGE=$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$FRONTEND_SERVICE:${{ github.sha }}

          gcloud run deploy $FRONTEND_SERVICE \
            --image $FRONTEND_IMAGE \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --port 8080 \
            --set-env-vars NODE_ENV=production \
            --clear-volume-mounts \
            --remove-labels managed-by

          FRONTEND_URL=$(gcloud run services describe $FRONTEND_SERVICE \
            --region $REGION \
            --format 'value(status.url)')
          echo "Frontend deployed to: $FRONTEND_URL"

      - name: Verify frontend health
        run: |
          FRONTEND_URL=$(gcloud run services describe $FRONTEND_SERVICE \
            --region $REGION \
            --format 'value(status.url)')
          sleep 10
          curl -f "$FRONTEND_URL" \
            || (echo "Frontend health check failed" && exit 1)
